<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿³å¥å±•ç¤º - TAKESHIBA Memories</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Shippori+Mincho:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 2160Ã—3840ç¸¦é•·ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            margin: 0;
            padding: 0;
            background: #f8f6f0;
            font-family: 'Noto Sans JP', sans-serif;
            overflow-x: hidden;
            height: 100vh;
        }

        /* åœ“å…‰å¯ºé¢¨ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£èƒŒæ™¯ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .display-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            box-sizing: border-box;
        }

        .display-header {
            text-align: center;
            margin-bottom: 50px;
            color: #333;
        }

        .display-title {
            font-size: 5rem;
            font-weight: 300;
            margin-bottom: 20px;
            letter-spacing: 0.1em;
        }

        .display-logo {
            max-width: 800px;
            width: 100%;
            height: auto;
            margin: 0 auto 20px;
            display: block;
        }

        .display-subtitle {
            font-size: 2.8rem;
            font-weight: 300;
            color: #000000;
            letter-spacing: 0.05em;
        }

        .haikus-container {
            width: 100%;
            max-width: 2000px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 60px;
            padding: 60px;
            overflow-y: auto;
            flex: 1;
        }

        .haiku-display-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 100px 80px;
            border-radius: 40px;
            box-shadow: 
                0 30px 60px rgba(0,0,0,0.1),
                0 0 0 1px rgba(255,255,255,0.2);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(102, 126, 234, 0.1);
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .haiku-display-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .haiku-display-card:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 40px 80px rgba(0,0,0,0.15),
                0 0 0 1px rgba(255,255,255,0.2);
        }

        .haiku-display-text {
            font-size: 3.5rem;
            line-height: 2.5;
            font-weight: bold;
            margin-bottom: 40px;
            letter-spacing: 0.1em;
            color: #2c3e50;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-family: 'Shippori Mincho', serif;
            min-height: 8em;
            display: flex;
            flex-direction: row; /* ç¸¦æ›¸ãã§ã¯è¡ŒãŒæ¨ªï¼ˆå³ã‹ã‚‰å·¦ï¼‰ã«ä¸¦ã¶ */
            justify-content: center;
            align-items: stretch;
            gap: 1.2em; /* è¡Œé–“ */
            height: auto;
            max-width: 100%;
        }
        
        .haiku-line {
            display: inline-block;
            writing-mode: vertical-rl; /* å„è¡Œæƒ…å ±ã‚’ç¸¦æ›¸ã */
            text-orientation: upright; /* æ–‡å­—ã‚’ç¸¦å‘ãã« */
            line-height: 1.8;
            letter-spacing: 0.2em;
        }

        .haiku-display-meta {
            display: flex;
            justify-content: space-between;
            font-size: 1.5rem;
            color: #7f8c8d;
            padding-top: 30px;
            border-top: 1px solid rgba(102, 126, 234, 0.1);
        }

        .loading-message {
            text-align: center;
            color: #7f8c8d;
            font-size: 2.5rem;
            padding: 100px;
        }

        .error-message {
            text-align: center;
            color: #e74c3c;
            font-size: 2.5rem;
            padding: 100px;
        }

        /* ç¸¦é•·ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤æœ€é©åŒ– */
        @media (min-width: 2160px) and (min-height: 3840px) {
            .haikus-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 80px;
                padding: 100px;
            }

            .haiku-display-text {
                font-size: 4.5rem;
                line-height: 2.8;
                gap: 1.5em; /* è¡Œé–“ã‚’ç‹­ã‚ã‚‹ */
            }

            .display-logo {
                max-width: 1000px;
            }

            .display-subtitle {
                font-size: 3rem;
            }
        }

        /* æ¨ªé•·ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤å¯¾å¿œ */
        @media (min-width: 3840px) and (max-height: 2160px) {
            .haikus-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 40px;
            }
        }

        /* é€šå¸¸ã®ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤å¯¾å¿œ */
        @media (max-width: 1920px) {
            .haikus-container {
                grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
                gap: 50px;
                padding: 50px;
            }

            .haiku-display-text {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <div class="display-container">
        <div class="display-header">
            <img src="/logo.svg" alt="" class="display-logo" onerror="this.style.display='none';">
            <p class="display-subtitle">ã¿ã‚“ãªã®ä¿³å¥</p>
        </div>
        
        <div class="haikus-container" id="haikus-container">
            <div class="loading-message">ä¿³å¥ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <script>
        const haikusContainer = document.getElementById('haikus-container');
        
        // å ´æ‰€åã®ãƒãƒƒãƒ”ãƒ³ã‚°
        const locationNames = {
            'takeshiba-station': 'ç«¹èŠé§…',
            'takeshiba-pier': 'ç«¹èŠæ¡Ÿæ©‹',
            'takeshiba-park': 'ç«¹èŠå…¬åœ’',
            'takeshiba-building': 'ç«¹èŠãƒ“ãƒ«',
            'chair': 'æ¤…å­',
            'elevator': 'ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼',
            'exhibition': 'å±•ç¤º',
            'garden': 'åº­åœ’',
            'restaurant': 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³'
        };

        function getLocationName(locationId) {
            return locationNames[locationId] || locationId || 'ç«¹èŠã‚¨ãƒªã‚¢';
        }

        // ä¿³å¥ã‚’èª­ã¿è¾¼ã‚€
        async function loadHaikus() {
            try {
                const response = await fetch('/api/haikus');
                const data = await response.json();
                
                if (data.haikus && data.haikus.length > 0) {
                    displayHaikus(data.haikus);
                } else {
                    haikusContainer.innerHTML = '<div class="loading-message">ã¾ã ä¿³å¥ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                }
            } catch (error) {
                console.error('ä¿³å¥èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                haikusContainer.innerHTML = '<div class="error-message">ä¿³å¥ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // æ—¥æœ¬èªã®æ–‡å­—ã‚’éŸ³æ•°ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆï¼ˆæ¦‚ç®—ï¼‰
        function countMorae(text) {
            // é•·éŸ³è¨˜å·ã‚„å°æ–‡å­—ã‚’è€ƒæ…®ã—ãŸç°¡æ˜“çš„ãªéŸ³æ•°ã‚«ã‚¦ãƒ³ãƒˆ
            let count = 0;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                // ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»æ¼¢å­—ã¯åŸºæœ¬çš„ã«1éŸ³
                if (/[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¯ã€…]/.test(char)) {
                    count++;
                }
                // é•·éŸ³è¨˜å·ã¯éŸ³æ•°ã«å«ã‚ãªã„ï¼ˆå‰ã®æ–‡å­—ã¨åˆã‚ã›ã¦1éŸ³ï¼‰
                else if (char === 'ãƒ¼' || char === 'âˆ’') {
                    // å‰ã®æ–‡å­—ã¨åˆã‚ã›ã¦1éŸ³ã¨ã—ã¦æ‰±ã†ãŸã‚ã€ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
                }
                // ãã®ä»–ã®æ–‡å­—ï¼ˆå¥èª­ç‚¹ã€ã‚¹ãƒšãƒ¼ã‚¹ãªã©ï¼‰ã¯éŸ³æ•°ã«å«ã‚ãªã„
            }
            return count;
        }

        // ä¿³å¥ã‚’5-7-5ã®3è¡Œã«æ•´å½¢ã™ã‚‹é–¢æ•°
        function formatHaikuToThreeLines(haikuText) {
            if (!haikuText || haikuText.trim() === '') {
                return 'ä¿³å¥ã‚’ç”Ÿæˆä¸­...\n\n';
            }
            
            // æ—¢å­˜ã®æ”¹è¡Œã‚’é™¤å»ã—ã¦1è¡Œã«
            const cleaned = haikuText.trim().replace(/\s+/g, '').replace(/[\n\r]+/g, '');
            
            // æ—¢ã«æ”¹è¡ŒãŒã‚ã‚‹å ´åˆã¯ã€ãã®æ”¹è¡Œã‚’ä¿æŒã—ã¦ç¢ºèª
            const originalLines = haikuText.trim().split(/[\n\r]+/).filter(line => line.trim() !== '');
            
            // æ—¢ã«3è¡Œã«ãªã£ã¦ã„ã¦ã€5-7-5ã«è¿‘ã„å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
            if (originalLines.length === 3) {
                const count1 = countMorae(originalLines[0]);
                const count2 = countMorae(originalLines[1]);
                const count3 = countMorae(originalLines[2]);
                // 5-7-5ã«è¿‘ã„å ´åˆï¼ˆè¨±å®¹ç¯„å›²ï¼šÂ±2éŸ³ï¼‰
                if (Math.abs(count1 - 5) <= 2 && Math.abs(count2 - 7) <= 2 && Math.abs(count3 - 5) <= 2) {
                    return originalLines.join('\n');
                }
            }
            
            // å…¨ä½“ã®æ–‡å­—åˆ—ã‹ã‚‰5-7-5ã«åˆ†å‰²
            const totalLength = cleaned.length;
            // 5:7:5ã®æ¯”ç‡ã§åˆ†å‰²ï¼ˆå…¨ä½“ãŒ17éŸ³ã‚’æƒ³å®šï¼‰
            // å®Ÿéš›ã®æ–‡å­—æ•°ãƒ™ãƒ¼ã‚¹ã§åˆ†å‰²
            const ratio1 = 5 / 17;  // æœ€åˆã®5éŸ³åˆ†
            const ratio2 = 12 / 17; // æœ€åˆã®12éŸ³åˆ†ï¼ˆ5+7ï¼‰
            
            let pos1 = Math.floor(totalLength * ratio1);
            let pos2 = Math.floor(totalLength * ratio2);
            
            // å¥èª­ç‚¹ã‚„ã‚¹ãƒšãƒ¼ã‚¹ã®è¿‘ãã§èª¿æ•´
            const findBestSplitPoint = (targetPos, text, range = 5) => {
                let bestPos = targetPos;
                let bestDistance = range;
                
                for (let i = Math.max(0, targetPos - range); i < Math.min(text.length, targetPos + range); i++) {
                    // å¥èª­ç‚¹ã‚„åˆ‡ã‚Œå­—ã®å¾Œã‚’å„ªå…ˆ
                    if (/[ã€ã€‚ã‚„ã‹ãªã‘ã‚Šãªã‚Š]/.test(text[i])) {
                        const distance = Math.abs(targetPos - i);
                        if (distance < bestDistance) {
                            bestDistance = distance;
                            bestPos = i + 1;
                        }
                    }
                }
                return bestPos;
            };
            
            pos1 = findBestSplitPoint(pos1, cleaned);
            pos2 = findBestSplitPoint(pos2, cleaned, 8);
            
            // 3è¡Œã«åˆ†å‰²
            const line1 = cleaned.substring(0, pos1).trim();
            const line2 = cleaned.substring(pos1, pos2).trim();
            const line3 = cleaned.substring(pos2).trim();
            
            return `${line1}\n${line2}\n${line3}`;
        }

        // ä¿³å¥ã‚’è¡¨ç¤º
        function displayHaikus(haikus) {
            haikusContainer.innerHTML = '';
            
            if (!haikus || haikus.length === 0) {
                haikusContainer.innerHTML = '<div class="loading-message">ã¾ã ä¿³å¥ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            // æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
            haikus.sort((a, b) => new Date(b.created_at || b.timestamp) - new Date(a.created_at || a.timestamp));
            
            // å…¨ã¦ã®ä¿³å¥ã‚’è¡¨ç¤ºï¼ˆåˆ¶é™ãªã—ï¼‰
            haikus.forEach(haiku => {
                const card = document.createElement('div');
                card.className = 'haiku-display-card';
                
                const date = new Date(haiku.created_at || haiku.timestamp);
                const formattedDate = date.toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // ä¿³å¥ã‚’5-7-5ã®3è¡Œã«æ•´å½¢
                const formattedHaiku = formatHaikuToThreeLines(haiku.haiku);
                const lines = formattedHaiku.split('\n');
                
                // ç¸¦æ›¸ãè¡¨ç¤ºç”¨ã«å„è¡Œã‚’ç¸¦ã«é…ç½®
                card.innerHTML = `
                    <div class="haiku-display-text">
                        ${lines.map((line, index) => `<span class="haiku-line" data-line="${index + 1}">${line}</span>`).join('')}
                    </div>
                    <div class="haiku-display-meta">
                        <div class="haiku-location">ğŸ“ ${getLocationName(haiku.location_id)}</div>
                        <div class="haiku-timestamp">${formattedDate}</div>
                    </div>
                `;
                
                haikusContainer.appendChild(card);
            });
        }

        // åˆæœŸèª­ã¿è¾¼ã¿
        loadHaikus();

        // å®šæœŸçš„ã«æ›´æ–°ï¼ˆ30ç§’ã”ã¨ï¼‰
        setInterval(loadHaikus, 30000);
    </script>
</body>
</html>

