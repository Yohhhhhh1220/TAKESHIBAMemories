<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>俳句展示 - TAKESHIBA Memories</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Shippori+Mincho:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 2160×3840縦長ディスプレイ専用のスタイル */
        body {
            margin: 0;
            padding: 0;
            background: #f8f6f0;
            font-family: 'Noto Sans JP', sans-serif;
            overflow-x: hidden;
            height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .display-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            box-sizing: border-box;
        }

        .display-header {
            text-align: center;
            margin-bottom: 50px;
            color: #333;
        }

        .display-title {
            font-size: 5rem;
            font-weight: 300;
            margin-bottom: 20px;
            letter-spacing: 0.1em;
        }

        .display-logo {
            max-width: 500px;
            width: 100%;
            height: auto;
            margin: 0 auto 20px;
            display: block;
        }

        .display-subtitle {
            font-size: 2.8rem;
            font-weight: 300;
            color: #000000;
            letter-spacing: 0.05em;
        }

        .haikus-container {
            width: 100%;
            max-width: 2000px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 60px;
            padding: 60px;
            overflow-y: auto;
            flex: 1;
        }

        .haiku-display-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 100px 80px;
            border-radius: 40px;
            box-shadow: 
                0 30px 60px rgba(0,0,0,0.1),
                0 0 0 1px rgba(255,255,255,0.2);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(102, 126, 234, 0.1);
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .haiku-display-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .haiku-display-card:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 40px 80px rgba(0,0,0,0.15),
                0 0 0 1px rgba(255,255,255,0.2);
        }

        .haiku-display-text {
            font-size: 3.5rem;
            line-height: 2.5;
            font-weight: bold;
            margin-bottom: 40px;
            letter-spacing: 0.1em;
            color: #2c3e50;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-family: 'Shippori Mincho', serif;
            min-height: 8em;
            display: flex;
            flex-direction: row-reverse; /* 縦書きでは行が横（右から左）に並ぶ */
            justify-content: center;
            align-items: stretch;
            gap: 1.2em; /* 行間 */
            height: auto;
            max-width: 100%;
        }
        
        .haiku-line {
            display: inline-block;
            writing-mode: vertical-rl; /* 各行情報を縦書き */
            text-orientation: upright; /* 文字を縦向きに */
            line-height: 1.8;
            letter-spacing: 0.2em;
        }

        .haiku-display-meta {
            display: flex;
            justify-content: space-between;
            font-size: 1.5rem;
            color: #7f8c8d;
            padding-top: 30px;
            border-top: 1px solid rgba(102, 126, 234, 0.1);
        }

        .loading-message {
            text-align: center;
            color: #7f8c8d;
            font-size: 2.5rem;
            padding: 100px;
        }

        .error-message {
            text-align: center;
            color: #e74c3c;
            font-size: 2.5rem;
            padding: 100px;
        }

        /* 縦長ディスプレイ最適化 */
        @media (min-width: 2160px) and (min-height: 3840px) {
            .haikus-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 80px;
                padding: 100px;
            }

            .haiku-display-text {
                font-size: 4.5rem;
                line-height: 2.8;
                gap: 1.5em; /* 行間を狭める */
            }

            .display-logo {
                max-width: 600px;
                width: 100%;
                height: auto;
            }

            .display-subtitle {
                font-size: 3rem;
            }
        }

        /* 横長ディスプレイ対応 */
        @media (min-width: 3840px) and (max-height: 2160px) {
            .haikus-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 40px;
            }
        }

        /* 通常のディスプレイ対応 */
        @media (max-width: 1920px) {
            .haikus-container {
                grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
                gap: 50px;
                padding: 50px;
            }

            .haiku-display-text {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <div class="display-container">
        <div class="display-header">
            <img src="/logo.png" alt="" class="display-logo" onerror="this.style.display='none';">
            <p class="display-subtitle">みんなの俳句</p>
        </div>
        
        <div class="haikus-container" id="haikus-container">
            <div class="loading-message">俳句を読み込み中...</div>
        </div>
    </div>

    <script>
        const haikusContainer = document.getElementById('haikus-container');
        

        // 俳句を読み込む
        async function loadHaikus() {
            try {
                const response = await fetch('/api/haikus');
                const data = await response.json();
                
                if (data.haikus && data.haikus.length > 0) {
                    displayHaikus(data.haikus);
                } else {
                    haikusContainer.innerHTML = '<div class="loading-message">まだ俳句がありません</div>';
                }
            } catch (error) {
                console.error('俳句読み込みエラー:', error);
                haikusContainer.innerHTML = '<div class="error-message">俳句の読み込みに失敗しました</div>';
            }
        }

        // 日本語の文字を音数としてカウント（概算）
        function countMorae(text) {
            // 長音記号や小文字を考慮した簡易的な音数カウント
            let count = 0;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                // ひらがな・カタカナ・漢字は基本的に1音
                if (/[ぁ-んァ-ン一-龯々]/.test(char)) {
                    count++;
                }
                // 長音記号は音数に含めない（前の文字と合わせて1音）
                else if (char === 'ー' || char === '−') {
                    // 前の文字と合わせて1音として扱うため、カウントしない
                }
                // その他の文字（句読点、スペースなど）は音数に含めない
            }
            return count;
        }

        // 俳句を5-7-5の3行に整形する関数
        function formatHaikuToThreeLines(haikuText) {
            if (!haikuText || haikuText.trim() === '') {
                return ['俳句を生成中...', '', ''];
            }
            
            // 既存の改行がある場合は、その改行を保持して確認
            const originalLines = haikuText.trim().split(/[\n\r]+/).filter(line => line.trim() !== '');
            
            // 既に3行になっていて、5-7-5に近い場合はそのまま使用
            if (originalLines.length === 3) {
                const count1 = countMorae(originalLines[0]);
                const count2 = countMorae(originalLines[1]);
                const count3 = countMorae(originalLines[2]);
                // 5-7-5に近い場合（許容範囲：±2音）
                if (Math.abs(count1 - 5) <= 2 && Math.abs(count2 - 7) <= 2 && Math.abs(count3 - 5) <= 2) {
                    return originalLines;
                }
            }
            
            // 既存の改行を除去して1行に
            const cleaned = haikuText.trim().replace(/\s+/g, '').replace(/[\n\r]+/g, '');
            
            if (cleaned.length === 0) {
                return ['', '', ''];
            }
            
            // 全体の文字列から5-7-5に分割
            const totalLength = cleaned.length;
            // 5:7:5の比率で分割（全体が17音を想定）
            const ratio1 = 5 / 17;  // 最初の5音分
            const ratio2 = 12 / 17; // 最初の12音分（5+7）
            
            let pos1 = Math.floor(totalLength * ratio1);
            let pos2 = Math.floor(totalLength * ratio2);
            
            // 句読点や切れ字の近くで調整
            const findBestSplitPoint = (targetPos, text, range = 5) => {
                let bestPos = targetPos;
                let bestDistance = range;
                
                // まず句読点や切れ字の後を探す
                for (let i = Math.max(0, targetPos - range); i < Math.min(text.length, targetPos + range); i++) {
                    if (/[、。やかなけりなり]/.test(text[i])) {
                        const distance = Math.abs(targetPos - i);
                        if (distance < bestDistance) {
                            bestDistance = distance;
                            bestPos = i + 1;
                        }
                    }
                }
                
                // 見つからない場合は、空白や区切り文字の後を探す
                if (bestPos === targetPos) {
                    for (let i = Math.max(0, targetPos - range); i < Math.min(text.length, targetPos + range); i++) {
                        if (/[\s　]/.test(text[i])) {
                            const distance = Math.abs(targetPos - i);
                            if (distance < bestDistance) {
                                bestDistance = distance;
                                bestPos = i + 1;
                            }
                        }
                    }
                }
                
                return bestPos;
            };
            
            pos1 = findBestSplitPoint(pos1, cleaned);
            pos2 = findBestSplitPoint(pos2, cleaned, 8);
            
            // 3行に分割（必ず3行になるようにする）
            const line1 = cleaned.substring(0, pos1).trim() || '';
            const line2 = cleaned.substring(pos1, pos2).trim() || '';
            const line3 = cleaned.substring(pos2).trim() || '';
            
            // 空行が含まれている場合は、均等に再分配
            if (!line1 || !line2 || !line3) {
                // 全体を3等分する
                const part1 = Math.ceil(totalLength / 3);
                const part2 = Math.ceil(totalLength * 2 / 3);
                return [
                    cleaned.substring(0, part1).trim() || '',
                    cleaned.substring(part1, part2).trim() || '',
                    cleaned.substring(part2).trim() || ''
                ];
            }
            
            return [line1, line2, line3];
        }

        // 俳句を表示
        function displayHaikus(haikus) {
            haikusContainer.innerHTML = '';
            
            if (!haikus || haikus.length === 0) {
                haikusContainer.innerHTML = '<div class="loading-message">まだ俳句がありません</div>';
                return;
            }
            
            // 新しい順にソート
            haikus.sort((a, b) => new Date(b.created_at || b.timestamp) - new Date(a.created_at || a.timestamp));
            
            // 全ての俳句を表示（制限なし）
            haikus.forEach(haiku => {
                const card = document.createElement('div');
                card.className = 'haiku-display-card';
                
                const date = new Date(haiku.created_at || haiku.timestamp);
                const formattedDate = date.toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // 俳句を5-7-5の3行に整形（配列で返される）
                const lines = formatHaikuToThreeLines(haiku.haiku);
                
                // 空行をフィルタリングして、必ず3行になるようにする
                const validLines = lines.filter(line => line && line.trim() !== '');
                const finalLines = validLines.length >= 3 ? validLines.slice(0, 3) : 
                                  validLines.length === 2 ? [...validLines, ''] :
                                  validLines.length === 1 ? [validLines[0], '', ''] : ['', '', ''];
                
                // 縦書き表示用に各行を縦に配置（右から左に表示されるように順序を保持）
                const penname = haiku.penname || '詠み人知らず';
                card.innerHTML = `
                    <div class="haiku-display-text">
                        ${finalLines.map((line, index) => `<span class="haiku-line" data-line="${index + 1}">${line || ''}</span>`).join('')}
                    </div>
                    <div class="haiku-display-meta">
                        <div class="haiku-penname">✍️ ${penname}</div>
                        <div class="haiku-timestamp">${formattedDate}</div>
                    </div>
                `;
                
                haikusContainer.appendChild(card);
            });
        }

        // 初期読み込み
        loadHaikus();

        // 定期的に更新（30秒ごと）
        setInterval(loadHaikus, 30000);
    </script>
</body>
</html>

